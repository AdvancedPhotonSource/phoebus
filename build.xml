<!-- Ant build file for building Phoebus

     All external dependencies need to be
     provided as jar files in a ../dependencies directory.
  -->
<project name="Phoebus" default="dist" basedir=".">
  <!-- Global properties -->
  <property name="version" value="0.0.1"/>
  <property name="src" value="src/main/java"/>
  <property name="resources" value="src/main/resources"/>
  <property name="build" value="target"/>
  <property name="classes" value="target/classes"/>
  <property name="dependencies" value="../dependencies"/>
  <path id="app-classpath">
    <pathelement path="core/framework/${classes}"/>
    <pathelement path="core/core-types/${classes}"/>
    <fileset dir="../dependencies">
      <include name="*.jar"/>
    </fileset>
  </path>

  <target name="init">
    <!-- Set ${DSTAMP} -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="core/framework/${classes}"/>
    <mkdir dir="core/logging/${classes}"/>
    <mkdir dir="core/core-types/${classes}"/>
    <mkdir dir="applications/probe/${classes}"/>
    <mkdir dir="applications/greetings/${classes}"/>
    <mkdir dir="phoebus-product/${classes}"/>
  </target>

  <target name="compile" depends="init">
    <!-- Compile the java code -->
    <javac includeantruntime="false" srcdir="core/framework/${src}" destdir="core/framework/${classes}"/>
    <javac includeantruntime="false" srcdir="core/logging/${src}" destdir="core/logging/${classes}">
      <classpath>
        <pathelement path="core/framework/${classes}"/>
      </classpath>
    </javac>
    <javac includeantruntime="false" srcdir="core/core-types/${src}" destdir="core/core-types/${classes}">
     <classpath>
        <pathelement path="core/framework/${classes}"/>
        <pathelement path="core/logging/${classes}"/>
      </classpath>
    </javac>

    <javac includeantruntime="false" srcdir="applications/probe/${src}" destdir="applications/probe/${classes}" classpathref="app-classpath"/>
    <javac includeantruntime="false" srcdir="applications/greetings/${src}" destdir="applications/greetings/${classes}" classpathref="app-classpath"/>

    <javac includeantruntime="false" srcdir="phoebus-product/${src}" destdir="phoebus-product/${classes}" classpathref="app-classpath"/>
  </target>

  <target name="dist" depends="compile">
    <!-- Create the jars -->
    <jar destfile="core/framework/${build}/framework-${version}.jar">
      <fileset dir="core/framework/${classes}"/>
      <fileset dir="core/framework/${resources}"/>
    </jar>
    <jar destfile="core/logging/${build}/logging-${version}.jar">
      <fileset dir="core/logging/${classes}"/>
    </jar>
    <jar destfile="core/core-types/${build}/core-types-${version}.jar">
      <fileset dir="core/core-types/${classes}"/>
    </jar>

    <jar destfile="applications/probe/${build}/probe-${version}.jar">
      <fileset dir="applications/probe/${classes}"/>
    </jar>
    <jar destfile="applications/greetings/${build}/greetings-${version}.jar">
      <fileset dir="applications/greetings/${classes}"/>
    </jar>

    <jar destfile="phoebus-product/${build}/product-${version}.jar">
      <fileset dir="phoebus-product/${classes}"/>
      <manifest>
        <attribute name="Main-Class" value="org.phoebus.product.Launcher" />
      </manifest>
    </jar>
  </target>

  <target name="clean">
    <!-- Delete the ${build} and ${dist} directory trees -->
    <delete dir="core/framework/${build}"/>
    <delete dir="core/logging/${build}"/>
    <delete dir="core/core-types/${build}"/>
    <delete dir="applications/probe/${build}"/>
    <delete dir="applications/greetings/${classes}"/>
    <delete dir="phoebus-product/${build}"/>
  </target>

  <target name="run" depends="dist">
    <java classname="org.phoebus.product.Launcher">
      <arg value="--add-modules=ALL-SYSTEM"/>
      <classpath>
        <pathelement location="phoebus-product/${build}/product-${version}.jar"/>
        <pathelement location="core/framework/${build}/framework-${version}.jar"/>
      </classpath>
    </java>
  </target>
</project>
